<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Â¢®ÁôΩÈü≥‰πêÁõí</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <style>
        :root{
            --bg:#0b0e1a;
            --panel:rgba(15,18,30,0.92);
            --accent:#ffcd32;
            --text-main:#ffffff;
            --text-sub:#9b9fab;
            --border:rgba(255,255,255,0.08);
            --glass:rgba(18,22,37,0.75);
        }
        *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
        html,body{margin:0;padding:0;height:100%;background:var(--bg);color:var(--text-main);font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Helvetica,"PingFang SC","Hiragino Sans GB",Microsoft YaHei,sans-serif;overflow:hidden;}
        #app{display:flex;flex-direction:column;height:100%;max-width:540px;margin:0 auto;background:var(--bg);}

        /* È°∂ÈÉ®ÂØºËà™ */
        .topbar{flex-shrink:0;height:52px;display:flex;align-items:center;padding:0 16px;background:var(--panel);border-bottom:1px solid var(--border);}
        .topbar .logo{font-size:18px;font-weight:600;letter-spacing:.5px;color:var(--accent);}
        .topbar .search{flex:1;margin:0 12px;position:relative;}
        .topbar .search input{width:100%;height:32px;border-radius:16px;border:none;background:rgba(255,255,255,.08);color:var(--text-main);padding:0 32px 0 12px;font-size:14px;outline:none;}
        .topbar .search .icon{position:absolute;right:10px;top:50%;transform:translateY(-50%);color:var(--text-sub);cursor:pointer;}
        .topbar .search .loading{position:absolute;right:36px;top:50%;transform:translateY(-50%);width:14px;height:14px;border:2px solid transparent;border-top:2px solid var(--accent);border-radius:50%;animation:spin .6s linear infinite;display:none;}
        @keyframes spin{to{transform:translateY(-50%) rotate(360deg);}}

        /* Êù•Ê∫êÈÄâÊã©Êù° */
        .sourcebar{flex-shrink:0;display:flex;gap:8px;padding:8px 16px;background:var(--panel);border-bottom:1px solid var(--border);font-size:12px;color:var(--text-sub);}
        .sourcebar label{display:flex;align-items:center;gap:4px;}
        .sourcebar input{margin:0;width:12px;height:12px;accent-color:var(--accent);}

        /* ‰∏≠Èó¥ÂÜÖÂÆπÂå∫ */
        .main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
        .tabs{flex-shrink:0;display:flex;justify-content:space-around;padding:8px 0;border-bottom:1px solid var(--border);}
        .tabs .tab{padding:6px 14px;font-size:14px;color:var(--text-sub);position:relative;}
        .tabs .tab.active{color:var(--accent);}
        .tabs .tab.active::after{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:20px;height:3px;background:var(--accent);border-radius:2px;}
        .scroll{flex:1;overflow-y:auto;padding:12px 16px;}
        .scroll::-webkit-scrollbar{width:0;}

        /* Ê≠åÊõ≤ÂàóË°®È°π */
        .track{display:flex;align-items:center;padding:10px 0;border-bottom:1px solid var(--border);}
        .track .index{width:28px;text-align:center;font-size:12px;color:var(--text-sub);}
        .track .cover{width:48px;height:48px;border-radius:6px;margin-right:12px;background:rgba(255,255,255,.08);object-fit:cover;}
        .track .info{flex:1;min-width:0;}
        .track .title{font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .track .artist{font-size:12px;color:var(--text-sub);margin-top:2px;display:flex;align-items:center;gap:4px;}
        .track .source-tag{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(255,255,255,.1);}
        .track .source-migu{color:#ffb74d;}
        .track .source-netease{color:#ff6b6b;}
        .track .source-qq{color:#4dd0e1;}
        .track .source-kuwo{color:#ba68c8;}
        .track .playbtn{width:32px;height:32px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:16px;display:flex;align-items:center;justify-content:center;margin-left:8px;}
        .track.playing .playbtn{background:#fff;color:var(--accent);}

        /* Â∫ïÈÉ®Êí≠ÊîæÂô® - ÁÆÄÂåñÁâà */
        .player{flex-shrink:0;height:64px;background:var(--panel);border-top:1px solid var(--border);display:flex;align-items:center;padding:8px 16px;position:relative;backdrop-filter:blur(20px);}
        .player .cover-wrapper{position:relative;margin-right:12px;}
        .player .cover{width:48px;height:48px;border-radius:8px;background:rgba(255,255,255,.08);object-fit:cover;box-shadow:0 2px 8px rgba(0,0,0,.3);}
        .player .play-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);border-radius:8px;opacity:0;transition:opacity .2s;cursor:pointer;}
        .player .play-overlay:hover{opacity:1;}
        .player .play-overlay button{width:24px;height:24px;border-radius:50%;border:none;background:var(--accent);color:#000;font-size:12px;display:flex;align-items:center;justify-content:center;}
        .player .info{flex:1;min-width:0;margin-right:12px;}
        .player .title{font-size:15px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
        .player .artist{font-size:12px;color:var(--text-sub);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
        .player .controls{display:flex;align-items:center;gap:8px;}
        .player .controls button{width:32px;height:32px;border-radius:50%;border:none;background:rgba(255,255,255,.1);color:var(--text-main);font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .2s;}
        .player .controls button:active{transform:scale(0.95);}
        .player .menu-btn{width:32px;height:32px;border-radius:50%;background:rgba(255,255,255,.1);color:var(--text-sub);font-size:16px;margin-left:8px;border:none;display:flex;align-items:center;justify-content:center;}
        
        /* ËøõÂ∫¶Êù° */
        .progress{position:absolute;left:0;right:0;top:0;height:3px;background:rgba(255,255,255,.1);cursor:pointer;}
        .progress .bar{height:100%;background:linear-gradient(90deg,var(--accent),#ff6b6b);transform-origin:left;transform:scaleX(0);border-radius:0 2px 2px 0;}
        .progress .handle{position:absolute;top:50%;transform:translateY(-50%);width:12px;height:12px;background:var(--accent);border-radius:50%;left:0;box-shadow:0 2px 6px rgba(255,205,50,.5);opacity:0;transition:opacity .2s;}
        .progress:hover .handle{opacity:1;}

        /* ÂÖ®Â±èÊí≠ÊîæÂô®Èù¢Êùø */
        .full-player-panel{
            position:fixed;
            inset:0;
            background:linear-gradient(135deg,var(--bg),#1a1f3a);
            display:flex;
            flex-direction:column;
            transform:translateY(100%);
            transition:transform .4s cubic-bezier(.4,0,.2,1);
            z-index:102;
        }
        .full-player-panel.show{
            transform:translateY(0);
        }
        .full-player-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .close-btn,.share-btn{
            width:40px;
            height:40px;
            border-radius:50%;
            background:rgba(255,255,255,.1);
            border:none;
            color:var(--text-main);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        .song-info{
            flex:1;
            text-align:center;
            margin:0 16px;
        }
        .full-title{
            font-size:16px;
            font-weight:600;
            margin-bottom:4px;
        }
        .full-artist{
            font-size:13px;
            color:var(--text-sub);
        }
        .full-player-cover{
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:40px;
        }
        .rotating-cover{
            width:280px;
            height:280px;
            border-radius:50%;
            object-fit:cover;
            background:rgba(255,255,255,.1);
            animation:rotate 20s linear infinite;
            box-shadow:0 8px 32px rgba(0,0,0,.4);
        }
        .rotating-cover.paused{
            animation-play-state:paused;
        }
        @keyframes rotate{
            from{transform:rotate(0deg);}
            to{transform:rotate(360deg);}
        }
        .full-player-progress{
            display:flex;
            align-items:center;
            padding:0 24px;
            margin-bottom:32px;
        }
        .time{
            font-size:12px;
            color:var(--text-sub);
            width:40px;
            text-align:center;
        }
        .full-progress{
            flex:1;
            height:4px;
            background:rgba(255,255,255,.2);
            border-radius:2px;
            margin:0 12px;
            position:relative;
            cursor:pointer;
        }
        .full-bar{
            height:100%;
            background:linear-gradient(90deg,var(--accent),#ff6b6b);
            border-radius:2px;
            transform-origin:left;
            transform:scaleX(0);
        }
        .full-handle{
            position:absolute;
            top:50%;
            transform:translateY(-50%);
            width:16px;
            height:16px;
            background:var(--accent);
            border-radius:50%;
            left:0;
            box-shadow:0 2px 8px rgba(255,205,50,.6);
        }
        .full-player-controls{
            display:flex;
            align-items:center;
            justify-content:center;
            gap:24px;
            padding:0 24px;
            margin-bottom:24px;
        }
        .control-btn{
            width:56px;
            height:56px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:24px;
            display:flex;
            align-items:center;
            justify-content:center;
            transition:all .2s;
        }
        .control-btn:active{
            transform:scale(0.95);
        }
        .play-btn{
            width:72px;
            height:72px;
            background:var(--accent);
            color:#000;
            font-size:32px;
            box-shadow:0 4px 16px rgba(255,205,50,.4);
        }
        .full-player-actions{
            display:flex;
            align-items:center;
            justify-content:space-around;
            padding:0 40px 24px;
        }
        .action-btn{
            width:48px;
            height:48px;
            border-radius:50%;
            border:none;
            background:rgba(255,255,255,.08);
            color:var(--text-sub);
            font-size:18px;
            display:flex;
            align-items:center;
            justify-content:center;
        }

        /* Ê≠åËØçËßÜÂõæ */
        .lyrics-view{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
        }
        .lyrics-scroll-full{
            flex:1;
            overflow-y:auto;
            padding:20px;
            text-align:center;
            font-size:22px;
            line-height:2.5;
            color:var(--text-sub);
            scroll-behavior:smooth;
        }
        .lyrics-scroll-full div{
            transition:all .35s cubic-bezier(.4,0,.2,1);
            margin:8px 0;
        }
        .lyrics-scroll-full .active{
            color:var(--accent);
            font-size:28px;
            font-weight:700;
            text-shadow:0 0 15px rgba(255,205,50,.55);
            transform:scale(1.05);
        }
        .lyrics-scroll-full.alt-style{
            background:linear-gradient(135deg,rgba(255,205,50,.1),rgba(255,105,180,.1));
            border-radius:12px;
            padding:20px;
        }
        .lyrics-scroll-full.alt-style .active{
            color:#ff69b4;
            text-shadow:0 0 20px rgba(255,105,180,.8);
            font-size:30px;
        }
        .lyrics-controls{
            display:flex;
            justify-content:center;
            gap:16px;
            padding:16px 24px 24px;
        }
        .lyrics-btn{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }
        
        /* Èü≥ÈáèÊéßÂà∂Èù¢Êùø */
        .volume-panel{
            position:absolute;
            inset:0;
            background:var(--bg);
            display:flex;
            flex-direction:column;
            z-index:103;
        }
        .volume-header{
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:12px 20px;
            height:56px;
        }
        .volume-title{
            font-size:16px;
            font-weight:600;
        }
        .volume-content{
            flex:1;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:40px;
        }
        .volume-display{
            font-size:48px;
            font-weight:700;
            color:var(--accent);
            margin-bottom:40px;
        }
        .volume-slider-full{
            width:80%;
            height:6px;
            background:rgba(255,255,255,.2);
            border-radius:3px;
            outline:none;
            -webkit-appearance:none;
            margin-bottom:40px;
        }
        .volume-slider-full::-webkit-slider-thumb{
            width:24px;
            height:24px;
            background:var(--accent);
            border-radius:50%;
            -webkit-appearance:none;
            cursor:pointer;
            box-shadow:0 2px 8px rgba(255,205,50,.4);
        }
        .volume-buttons{
            display:flex;
            gap:12px;
            flex-wrap:wrap;
            justify-content:center;
        }
        .volume-btn,.volume-preset{
            padding:8px 16px;
            border:1px solid var(--border);
            border-radius:20px;
            background:rgba(255,255,255,.1);
            color:var(--text-main);
            font-size:14px;
        }

        /* ÈÅÆÁΩ©Â±Ç */
        .lyrics-mask{
            position:fixed;
            inset:0;
            background:rgba(0,0,0,.55);
            z-index:100;
            display:none;
            opacity:0;
            transition:opacity .3s cubic-bezier(.4,0,.2,1);
        }
        .lyrics-mask.show{
            display:block;
            opacity:1;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- È°∂ÈÉ® -->
    <header class="topbar">
        <div class="logo">Â¢®ÁôΩÈü≥‰πêÁõí</div>
        <div class="search">
            <input id="searchInput" placeholder="ÊêúÁ¥¢Èü≥‰πê„ÄÅÊ≠åÊâã">
            <span class="loading" id="loading"></span>
            <span class="icon" id="searchIcon">üîç</span>
        </div>
    </header>

    <!-- Êù•Ê∫êÈÄâÊã© -->
    <div class="sourcebar">
        <label><input type="checkbox" data-src="migu">Âí™Âíï</label>
        <label><input type="checkbox" data-src="netease" checked>ÁΩëÊòì‰∫ë</label>
        <label><input type="checkbox" data-src="qq">QQ</label>
        <label><input type="checkbox" data-src="kuwo">ÈÖ∑Êàë</label>
    </div>

    <!-- ‰∏≠Èó¥ -->
    <main class="main">
        <nav class="tabs">
            <div class="tab active" data-tab="results">ÊêúÁ¥¢</div>
            <div class="tab" data-tab="favorites">Êî∂Ëóè</div>
            <div class="tab" data-tab="playlists">Ê≠åÂçï</div>
        </nav>
        <div id="scroll" class="scroll"></div>
    </main>

    <!-- Â∫ïÈÉ®Êí≠ÊîæÂô® - ÁÆÄÂåñÁâà -->
    <footer class="player" id="player">
        <div id="progressWrapper" class="progress">
            <div id="progressBar" class="bar"></div>
            <div id="progressHandle" class="handle"></div>
        </div>
        <div class="cover-wrapper">
            <img id="cover" class="cover" style="display:none">
            <div class="play-overlay">
                <button id="playBtn">‚ñ∂</button>
            </div>
        </div>
        <div class="info">
            <div id="title" class="title">ÊöÇÊú™ÈÄâÊã©Ê≠åÊõ≤</div>
            <div id="artist" class="artist">ÁÇπÂáªÈÄâÊã©Èü≥‰πê</div>
        </div>
        <div class="controls">
            <button id="playPauseBtn">‚ñ∂</button>
            <button id="nextBtn">‚è≠</button>
            <button id="favBtn">‚ù§</button>
        </div>
        <button id="menuBtn" class="menu-btn">‚ãØ</button>
    </footer>
</div>

<!-- ÂÖ®Â±èÊí≠ÊîæÂô®Èù¢Êùø -->
<div id="fullPlayerMask" class="lyrics-mask"></div>
<div id="fullPlayerPanel" class="full-player-panel">
    <div class="full-player-header">
        <button id="fullPlayerClose" class="close-btn">‚Üì</button>
        <div class="song-info">
            <div id="fullTitle" class="full-title">--</div>
            <div id="fullArtist" class="full-artist">--</div>
        </div>
        <button id="shareBtn" class="share-btn">‚ãØ</button>
    </div>
    <div class="full-player-cover">
        <img id="fullCover" class="rotating-cover" src="">
    </div>
    <div class="full-player-progress">
        <span id="currentTime" class="time">00:00</span>
        <div id="fullProgressWrapper" class="full-progress">
            <div id="fullProgressBar" class="full-bar"></div>
            <div id="fullProgressHandle" class="full-handle"></div>
        </div>
        <span id="totalTime" class="time">00:00</span>
    </div>
    <div class="full-player-controls">
        <button id="fullModeBtn" class="control-btn">üîÅ</button>
        <button id="fullPrevBtn" class="control-btn">‚èÆ</button>
        <button id="fullPlayBtn" class="control-btn play-btn">‚ñ∂</button>
        <button id="fullNextBtn" class="control-btn">‚è≠</button>
        <button id="fullFavBtn" class="control-btn">‚ù§</button>
    </div>
    <div class="full-player-actions">
        <button id="fullDownloadBtn" class="action-btn">‚¨á</button>
        <button id="fullLyricsBtn" class="action-btn">ËØç</button>
        <button id="fullVolumeBtn" class="action-btn">üîä</button>
        <button id="fullListBtn" class="action-btn">‚ò∞</button>
    </div>
    
    <!-- Ê≠åËØçËßÜÂõæ -->
    <div id="lyricsView" class="lyrics-view" style="display:none;">
        <div class="full-player-header">
            <button id="lyricsBackBtn" class="close-btn">‚Üê</button>
            <div class="song-info">
                <div id="lyricsTitle" class="full-title">--</div>
                <div id="lyricsArtist" class="full-artist">--</div>
            </div>
            <button id="lyricsStyleBtn" class="share-btn">üé®</button>
        </div>
        <div id="lyricsScroll" class="lyrics-scroll-full"></div>
        <div class="lyrics-controls">
            <button id="jumpPrev" class="lyrics-btn">‰∏ä‰∏ÄÂè•</button>
            <button id="jumpNext" class="lyrics-btn">‰∏ã‰∏ÄÂè•</button>
        </div>
    </div>
    
    <!-- Èü≥ÈáèÊéßÂà∂Èù¢Êùø -->
    <div id="volumePanel" class="volume-panel" style="display:none;">
        <div class="volume-header">
            <button id="volumeBackBtn" class="close-btn">‚Üê</button>
            <div class="volume-title">Èü≥ÈáèÊéßÂà∂</div>
            <div style="width:40px;"></div>
        </div>
        <div class="volume-content">
            <div class="volume-display">
                <span id="volumeValue">70</span>%
            </div>
            <input id="volumeSlider" class="volume-slider-full" type="range" min="0" max="1" step="0.01" value="0.7">
            <div class="volume-buttons">
                <button id="muteBtn" class="volume-btn">üîä</button>
                <button class="volume-preset" data-volume="0.3">30%</button>
                <button class="volume-preset" data-volume="0.5">50%</button>
                <button class="volume-preset" data-volume="0.7">70%</button>
                <button class="volume-preset" data-volume="1.0">100%</button>
            </div>
        </div>
    </div>
</div>

<!-- Èü≥È¢ë -->
<audio id="audio" preload="metadata"></audio>

<script>
    (function(){
        const state={
            enabledSources:{migu:false,netease:true,qq:false,kuwo:false},
            perLimit:20,
            keyword:'',
            results:[],
            favorites:[],
            playlists:[],
            current:null,
            playing:false,
            mode:'list',
            lyrics:[],
            lyricIndex:-1,
            noMore:false,
            isSearching:false,
            volume:0.7,
            muted:false,
            lyricsAlt:false
        };
        const dom={};
        function $(id){return document.getElementById(id);}
        function toast(msg){
            const el=document.createElement('div');
            el.style.cssText="position:fixed;left:50%;bottom:60px;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:6px 14px;border-radius:14px;font-size:12px;z-index:200";
            el.textContent=msg;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(),1500);
        }
        function fmt(s){
            if(!isFinite(s)||s<0)s=0;
            const m=Math.floor(s/60);
            const sec=Math.floor(s%60);
            return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
        }
        function setLoading(v){$('loading').style.display=v?'block':'none';}

        // Âä†ËΩΩÈªòËÆ§ÁΩëÊòì‰∫ëÊé®Ëçê
        async function loadDefault(){
            if(state.keyword) return;
            setLoading(true);
            state.isSearching=true;
            try{
                const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=ÁÉ≠Ê≠åÊ¶ú&num=${state.perLimit}&n=`;
                const res=await fetch(url);
                const j=await res.json();
                if(j.code===200&&Array.isArray(j.data)){
                    j.data.forEach(it=>{
                        const uid=`netease-${it.songid}`;
                        if(state.results.find(t=>t.uid===uid))return;
                        state.results.push({
                            uid,source:'netease',songid:it.songid,
                            title:it.title,singer:it.singer,
                            cover:it.pic||null,url:null,lrc:null,done:false
                        });
                    });
                }
            }catch(e){}
            setLoading(false);
            state.isSearching=false;
            renderList();
        }

        async function searchAll(reset){
            if(reset){state.results=[];state.noMore=false;}
            const enabled=Object.keys(state.enabledSources).filter(k=>state.enabledSources[k]);
            if(!enabled.length){toast('ËØ∑Ëá≥Â∞ëÈÄâÊã©‰∏Ä‰∏™Êù•Ê∫ê');return;}
            setLoading(true);
            state.isSearching=true;
            const tasks=enabled.map(src=>{
                if(src==='migu')return searchMigu(state.keyword,state.perLimit);
                if(src==='netease')return searchNetease(state.keyword,state.perLimit);
                return searchQQKuwo(state.keyword,state.perLimit,src);
            });
            let added=0;
            try{const res=await Promise.all(tasks);added=res.reduce((a,b)=>a+b,0);}catch(e){toast('ÊêúÁ¥¢Âá∫Èîô');}
            setLoading(false);
            state.isSearching=false;
            if(!reset&&added===0){state.noMore=true;toast('Ê≤°ÊúâÊõ¥Â§ö‰∫Ü');}
            renderList();
        }
        async function searchMigu(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/mgmusic_lingsheng.php?msg=${encodeURIComponent(kw||'')}&limit=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`migu-${kw||''}-${it.n||0}-${it.title}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'migu',title:it.title,singer:it.singer,cover:null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchNetease(kw,limit){
            const url=`https://api-v1.cenguigui.cn/api/music/netease/WyY_Dg.php?type=json&msg=${encodeURIComponent(kw||'ÁÉ≠Ê≠åÊ¶ú')}&num=${limit}&n=`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!Array.isArray(j.data))return 0;let added=0;j.data.forEach(it=>{const uid=`netease-${it.songid}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:'netease',songid:it.songid,title:it.title,singer:it.singer,cover:it.pic||null,url:null,lrc:null,done:false});added++;});return added;
        }
        async function searchQQKuwo(kw,limit,src){
            const url=`https://music-dl.sayqz.com/api?type=search&keyword=${encodeURIComponent(kw)}&source=${src}&limit=${limit}`;const res=await fetch(url);const j=await res.json();if(j.code!==200||!j.data||!Array.isArray(j.data.results))return 0;let added=0;j.data.results.forEach(it=>{const uid=`${src}-${it.id}`;if(state.results.find(t=>t.uid===uid))return;state.results.push({uid,source:src,title:it.name,singer:it.artist,cover:it.pic,url:it.url,lrc:it.lrc,done:!!it.url});added++;});return added;
        }
        async function ensureDetail(track){
            if(track.done&&track.url)return;
            if(track.source==='migu'){const url=`https://api-v1.cenguigui.cn/api/mg_music/?msg=${encodeURIComponent(track.title)}&n=1&type=json&br=1`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.music_url;track.cover=j.data.cover;track.lrc=j.data.lrc_url?await(await fetch(j.data.lrc_url)).text():null;track.done=true;}}
            if(track.source==='netease'){const url=`https://api.cenguigui.cn/api/netease/music_v1.php?id=${track.songid}&type=json&level=lossless`;const res=await fetch(url);const j=await res.json();if(j.code===200&&j.data){track.url=j.data.url;track.cover=j.data.pic;track.lrc=j.data.lyric;track.done=true;}}
        }
        function parseLRC(txt){if(!txt)return[];const lines=txt.split(/\r?\n/);const reg=/\[(\d{1,2}):(\d{1,2})(?:\.(\d{1,3}))?\]/;const out=[];lines.forEach(line=>{const m=reg.exec(line);if(!m)return;const time=parseInt(m[1])*60+parseInt(m[2])+((m[3]?parseInt(m[3].padEnd(3,'0')):0)/1000);const text=line.replace(reg,'').trim();if(text)out.push({time,text});});out.sort((a,b)=>a.time-b.time);return out;}
        function renderList(){
            const wrap=$('scroll');wrap.innerHTML='';const tab=document.querySelector('.tab.active').dataset.tab;let list=[];if(tab==='results')list=state.results;else if(tab==='favorites')list=state.favorites;else{const pl=state.playlists.find(p=>p.id===(state.playContext.playlistId||''));list=pl?pl.tracks:[];}list.forEach((tr,idx)=>{const row=document.createElement('div');row.className='track';const srcTag=tr.source==='migu'?'Âí™Âíï':tr.source==='netease'?'ÁΩëÊòì‰∫ë':tr.source==='qq'?'QQ':'ÈÖ∑Êàë';row.innerHTML=`
        <div class="index">${idx+1}</div>
        <img class="cover" src="${tr.cover||''}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'">
        <div class="cover-placeholder" style="width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,rgba(255,205,50,.15),rgba(255,183,77,.15));display:none;margin-right:12px;flex-shrink:0;text-align:center;line-height:48px;color:var(--accent);font-size:22px;box-shadow:0 2px 6px rgba(255,205,50,.2);">üéµ</div>
        <div class="info">
          <div class="title">${tr.title||'Unknown'}</div>
          <div class="artist"><span class="source-tag source-${tr.source}">${srcTag}</span>${tr.singer||''}</div>
        </div>
        <button class="playbtn">‚ñ∂</button>
      `;row.querySelector('.playbtn').onclick=async()=>{await playTrack(tr);};row.onclick=()=>row.querySelector('.playbtn').click();wrap.appendChild(row);});}
        async function playTrack(track){
            state.current=track;await ensureDetail(track);if(!track.url){toast('Êí≠ÊîæÂ§±Ë¥•');return;}
            $('audio').src=track.url;$('audio').play();state.playing=true;updateUI();
            state.lyrics=track.lrc?parseLRC(track.lrc):[];renderLyrics();
        }
        function updateUI(){const tr=state.current;$('title').textContent=tr?tr.title:'ÊöÇÊú™ÈÄâÊã©Ê≠åÊõ≤';$('artist').textContent=tr?tr.singer:'ÁÇπÂáªÈÄâÊã©Èü≥‰πê';if($('fullTitle'))$('fullTitle').textContent=tr?tr.title:'--';if($('fullArtist'))$('fullArtist').textContent=tr?tr.singer:'--';const cover=tr&&tr.cover?tr.cover:'';$('cover').src=cover;$('cover').style.display=tr&&tr.cover?'block':'none';if($('fullCover'))$('fullCover').src=cover||'';$('playBtn').textContent=state.playing?'‚è∏':'‚ñ∂';$('playPauseBtn').textContent=state.playing?'‚è∏':'‚ñ∂';if($('fullPlayBtn'))$('fullPlayBtn').textContent=state.playing?'‚è∏':'‚ñ∂';const isFav=tr&&state.favorites.find(f=>f.uid===tr.uid);if($('fullFavBtn'))$('fullFavBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';$('favBtn').style.color=isFav?'#ff6b6b':'var(--text-main)';document.querySelectorAll('.track').forEach(el=>{const uid=state.current?state.current.uid:null;const list=[...state.results,...state.favorites,...state.playlists.flatMap(p=>p.tracks)];const track=list.find(t=>t.uid===uid);el.classList.toggle('playing',track&&el.querySelector('.playbtn').onclick.toString().includes(track.uid));});}
        function renderLyrics(){
            const wrap=$('lyricsScroll');
            wrap.innerHTML='';
            if(!state.lyrics.length){
                wrap.innerHTML='<div style="margin-top:30px;color:var(--text-sub)">ÊöÇÊó†Ê≠åËØç</div>';
                return;
            }
            state.lyrics.forEach((l,i)=>{
                const div=document.createElement('div');
                div.textContent=l.text;
                div.dataset.idx=i;
                div.dataset.time=l.time;
                wrap.appendChild(div);
            });
            state.lyricIndex=-1;
            $('lyricsTitle').textContent=state.current?state.current.title:'--';
            $('lyricsArtist').textContent=state.current?state.current.singer:'--';
        }
        function updateLyrics(time){
            if(!state.lyrics.length)return;
            let idx=state.lyrics.findIndex((l,i)=>{
                const next=state.lyrics[i+1];
                return time>=l.time&&(next?time<next.time:true);
            });
            if(idx<0||idx===state.lyricIndex)return;
            state.lyricIndex=idx;
            document.querySelectorAll('#lyricsScroll div').forEach((el,i)=>el.classList.toggle('active',i===idx));
            const active=$('lyricsScroll').querySelector('.active');
            if(active)active.scrollIntoView({block:'center',behavior:'smooth'});
        }
        function updateVolumeDisplay(){
            const vol=Math.round(dom.audio.volume*100);
            $('volumeValue').textContent=vol;
        }

        function toggleFav(){if(!state.current)return;const idx=state.favorites.findIndex(t=>t.uid===state.current.uid);if(idx>=0){state.favorites.splice(idx,1);toast('Â∑≤ÂèñÊ∂àÊî∂Ëóè');}else{state.favorites.push(state.current);toast('Â∑≤Êî∂Ëóè');}updateUI();renderList();}
        function nextTrack(dir){const tab=document.querySelector('.tab.active').dataset.tab;let list=[];if(tab==='results')list=state.results;else if(tab==='favorites')list=state.favorites;else{const pl=state.playlists.find(p=>p.id===(state.playContext.playlistId||''));list=pl?pl.tracks:[];}if(!list.length)return;let idx=list.findIndex(t=>t.uid===state.current.uid);if(idx<0)idx=0;if(state.mode==='single'){$('audio').currentTime=0;$('audio').play();return;}if(state.mode==='shuffle'){if(list.length===1)idx=0;else{let n;do{n=Math.floor(Math.random()*list.length);}while(n===idx);idx=n;}}else{idx=(idx+(dir==='prev'?-1:1)+list.length)%list.length;}playTrack(list[idx]);}

        function togglePlayMode(){
            const modes=['list','single','shuffle'];
            const idx=modes.indexOf(state.mode);
            state.mode=modes[(idx+1)%modes.length];
            updateModeUI();
            const modeNames={list:'ÂàóË°®Êí≠Êîæ',single:'ÂçïÊõ≤Âæ™ÁéØ',shuffle:'ÈöèÊú∫Êí≠Êîæ'};
            toast(modeNames[state.mode]);
        }
        function updateModeUI(){
            const icons={list:'üîÅ',single:'üîÇ',shuffle:'üîÄ'};
            if($('fullModeBtn'))$('fullModeBtn').textContent=icons[state.mode];
        }
        async function downloadCurrent(){
            if(!state.current){toast('ËØ∑ÂÖàÈÄâÊã©Ê≠åÊõ≤');return;}
            await ensureDetail(state.current);
            if(!state.current.url){toast('Êó†Ê≥ïËé∑Âèñ‰∏ãËΩΩÈìæÊé•');return;}
            try{
                const response = await fetch(state.current.url);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${state.current.title}-${state.current.singer}.mp3`;
                a.target = '_blank';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                toast('ÂºÄÂßã‰∏ãËΩΩ');
            }catch(e){
                // Â§áÁî®ÊñπÊ°àÔºöÁõ¥Êé•ÊâìÂºÄÈìæÊé•
                window.open(state.current.url, '_blank');
                toast('Â∑≤Âú®Êñ∞Ê†áÁ≠æÈ°µÊâìÂºÄ‰∏ãËΩΩÈìæÊé•');
            }
        }

        function setup(){
            dom.audio=$('audio');dom.searchInput=$('searchInput');dom.playBtn=$('playBtn');dom.playPauseBtn=$('playPauseBtn');dom.nextBtn=$('nextBtn');dom.progressBar=$('progressBar');dom.progressWrapper=$('progressWrapper');dom.progressHandle=$('progressHandle');dom.menuBtn=$('menuBtn');dom.fullPlayerMask=$('fullPlayerMask');dom.fullPlayerPanel=$('fullPlayerPanel');dom.fullPlayerClose=$('fullPlayerClose');dom.fullCover=$('fullCover');dom.fullPlayBtn=$('fullPlayBtn');dom.fullPrevBtn=$('fullPrevBtn');dom.fullNextBtn=$('fullNextBtn');dom.fullFavBtn=$('fullFavBtn');dom.fullModeBtn=$('fullModeBtn');dom.fullDownloadBtn=$('fullDownloadBtn');dom.fullLyricsBtn=$('fullLyricsBtn');dom.fullVolumeBtn=$('fullVolumeBtn');dom.fullProgressWrapper=$('fullProgressWrapper');dom.fullProgressBar=$('fullProgressBar');dom.fullProgressHandle=$('fullProgressHandle');dom.favBtn=$('favBtn');
            
            dom.searchInput.addEventListener('keydown',e=>{if(e.key==='Enter'){state.keyword=dom.searchInput.value.trim();searchAll(true);}});
            $('searchIcon').addEventListener('click',()=>{state.keyword=dom.searchInput.value.trim();searchAll(true);});
            document.querySelectorAll('.sourcebar input').forEach(cb=>cb.addEventListener('change',()=>{state.enabledSources[cb.dataset.src]=cb.checked;}));
            document.querySelectorAll('.tab').forEach(tab=>tab.addEventListener('click',()=>{document.querySelectorAll('.tab').forEach(t=>t.classList.toggle('active',t===tab));renderList();}));
            
            dom.playBtn.addEventListener('click',()=>{if(!state.current)return;if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();});
            dom.playPauseBtn.addEventListener('click',()=>{if(!state.current)return;if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();});
            dom.nextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.favBtn.addEventListener('click',toggleFav);
            dom.menuBtn.addEventListener('click',()=>{dom.fullPlayerMask.classList.add('show');dom.fullPlayerPanel.classList.add('show');});
            
            // ÂÖ®Â±èÊí≠ÊîæÂô®‰∫ã‰ª∂
            dom.fullPlayBtn.addEventListener('click',()=>{if(!state.current)return;if(dom.audio.paused){dom.audio.play();state.playing=true;}else{dom.audio.pause();state.playing=false;}updateUI();});
            dom.fullPrevBtn.addEventListener('click',()=>nextTrack('prev'));
            dom.fullNextBtn.addEventListener('click',()=>nextTrack('next'));
            dom.fullFavBtn.addEventListener('click',toggleFav);
            dom.fullModeBtn.addEventListener('click',togglePlayMode);
            dom.fullDownloadBtn.addEventListener('click',downloadCurrent);
            dom.fullLyricsBtn.addEventListener('click',()=>{$('lyricsView').style.display='flex';});
            dom.fullVolumeBtn.addEventListener('click',()=>{$('volumePanel').style.display='flex';updateVolumeDisplay();});
            dom.fullProgressWrapper.addEventListener('click',e=>{const rect=dom.fullProgressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            
            // Ê≠åËØçÂíåÈü≥ÈáèÈù¢Êùø
            $('lyricsBackBtn').addEventListener('click',()=>{$('lyricsView').style.display='none';});
            $('volumeBackBtn').addEventListener('click',()=>{$('volumePanel').style.display='none';});
            $('volumeSlider').addEventListener('input',()=>{dom.audio.volume=parseFloat($('volumeSlider').value);updateVolumeDisplay();});
            $('muteBtn').addEventListener('click',()=>{state.muted=!state.muted;dom.audio.muted=state.muted;$('muteBtn').textContent=state.muted?'üîá':'üîä';});
            document.querySelectorAll('.volume-preset').forEach(btn=>btn.addEventListener('click',()=>{const vol=parseFloat(btn.dataset.volume);dom.audio.volume=vol;$('volumeSlider').value=vol;updateVolumeDisplay();}));
            $('jumpPrev').onclick=()=>{if(state.lyricIndex>0){dom.audio.currentTime=state.lyrics[state.lyricIndex-1].time+.1;}};
            $('jumpNext').onclick=()=>{if(state.lyricIndex<state.lyrics.length-1){dom.audio.currentTime=state.lyrics[state.lyricIndex+1].time+.1;}};
            $('lyricsStyleBtn').onclick=()=>{state.lyricsAlt=!state.lyricsAlt;$('lyricsScroll').classList.toggle('alt-style',state.lyricsAlt);toast('Ê≠åËØçÊ†∑ÂºèÂ∑≤ÂàáÊç¢');};
            
            dom.progressWrapper.addEventListener('click',e=>{const rect=dom.progressWrapper.getBoundingClientRect();const r=(e.clientX-rect.left)/rect.width;const dur=dom.audio.duration||0;dom.audio.currentTime=Math.max(0,Math.min(dur,dur*r));});
            dom.audio.addEventListener('timeupdate',()=>{const cur=dom.audio.currentTime||0;const dur=dom.audio.duration||0;const r=dur?cur/dur:0;dom.progressBar.style.transform='scaleX('+r+')';const w=dom.progressWrapper.clientWidth;dom.progressHandle.style.left=(w*r)+'px';if(dom.fullProgressBar){dom.fullProgressBar.style.transform='scaleX('+r+')';const fw=dom.fullProgressWrapper.clientWidth;dom.fullProgressHandle.style.left=(fw*r)+'px';}if($('currentTime'))$('currentTime').textContent=fmt(cur);if($('totalTime'))$('totalTime').textContent=fmt(dur);updateLyrics(cur);});
            dom.audio.addEventListener('ended',()=>nextTrack('next'));dom.audio.addEventListener('play',()=>{state.playing=true;updateUI();if(dom.fullCover)dom.fullCover.classList.remove('paused');});dom.audio.addEventListener('pause',()=>{state.playing=false;updateUI();if(dom.fullCover)dom.fullCover.classList.add('paused');});
            
            document.querySelectorAll('.controls button').forEach(btn=>btn.addEventListener('click',e=>e.stopPropagation()));
            document.querySelector('.cover-wrapper').addEventListener('click',e=>e.stopPropagation());
            document.querySelector('.player').addEventListener('click',()=>{
                dom.fullPlayerMask.classList.add('show');
                dom.fullPlayerPanel.classList.add('show');
            });
            
            dom.fullPlayerClose.addEventListener('click',closeFullPlayer);
            dom.fullPlayerMask.addEventListener('click',closeFullPlayer);
            function closeFullPlayer(){
                dom.fullPlayerMask.classList.remove('show');
                dom.fullPlayerPanel.classList.remove('show');
                $('lyricsView').style.display='none';
                $('volumePanel').style.display='none';
            }
            
            // ÈîÆÁõòÂø´Êç∑ÈîÆ
            document.addEventListener('keydown',e=>{
                const tag=document.activeElement.tagName.toLowerCase();
                const typing=(tag==='input'||tag==='textarea');
                if(e.code==='Space'&&!typing){e.preventDefault();if(dom.playPauseBtn)dom.playPauseBtn.click();else dom.playBtn.click();}
                if(e.key==='ArrowRight'&&!typing){dom.audio.currentTime=(dom.audio.currentTime||0)+5;}
                if(e.key==='ArrowLeft'&&!typing){dom.audio.currentTime=Math.max(0,(dom.audio.currentTime||0)-5);}
                if(e.key==='ArrowUp'&&!typing){dom.audio.volume=Math.min(1,(dom.audio.volume||0)+0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if(e.key==='ArrowDown'&&!typing){dom.audio.volume=Math.max(0,(dom.audio.volume||0)-0.05);if($('volumeSlider'))$('volumeSlider').value=dom.audio.volume;updateVolumeDisplay();}
                if((e.key==='n'||e.key==='N')&&!typing)nextTrack('next');
                if((e.key==='p'||e.key==='P')&&!typing)nextTrack('prev');
                if((e.key==='f'||e.key==='F')&&!typing)toggleFav();
                if((e.key==='m'||e.key==='M')&&!typing){state.muted=!state.muted;dom.audio.muted=state.muted;toast(state.muted?'Â∑≤ÈùôÈü≥':'Â∑≤ÂèñÊ∂àÈùôÈü≥');}
                if((e.key==='d'||e.key==='D')&&!typing)downloadCurrent();
                if(e.key==='/'&&!typing){e.preventDefault();dom.searchInput.focus();dom.searchInput.select();}
            });
            
            // ÂàùÂßãÂåñ
            dom.audio.volume=state.volume;
            updateModeUI();
            updateVolumeDisplay();
            loadDefault();
        }
        document.addEventListener('DOMContentLoaded',setup);
    })();
</script>
</body>
</html>
